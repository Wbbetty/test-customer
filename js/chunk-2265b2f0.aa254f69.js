(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2265b2f0"],{1054:function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e._self._c;return t("div",{staticClass:"chat-container"},[e.customer?t("div",{staticClass:"chat-title"},[e.customer.avatar?t("img",{staticClass:"chat-avatar",attrs:{src:e.customer.avatar}}):t("img",{staticClass:"chat-avatar",attrs:{src:s("1dee")}}),t("div",{staticClass:"chat-name"},[e._v(e._s(e.renderCustomerName(e.customer)))])]):e._e(),t("div",{ref:"scrollView",staticClass:"chat-main"},[t("div",{ref:"messageList",staticClass:"message-list"},[e.history.loading?t("div",{staticClass:"history-loading"},[t("img",{attrs:{src:s("912a")}})]):t("div",{staticClass:"history-loaded",on:{click:function(t){return e.loadHistoryMessage(!1)}}},[e._v(" "+e._s(e.history.allLoaded?"已经没有更多的历史消息":"获取历史消息")+" ")]),e._l(e.history.messages,(function(s,a){return t("div",{key:a},[t("div",{staticClass:"time-tips"},[e._v(" "+e._s(e.renderMessageDate(s,a))+" ")]),t("div",{staticClass:"message-item"},["CS_ACCEPT"===s.type?t("div",{staticClass:"accept-message"},[e._v(" "+e._s(s.senderData.name)+"已接入 ")]):"CS_END"===s.type?t("div",{staticClass:"accept-message"},[e._v(" "+e._s(s.senderData.name)+"已结束会话 ")]):"CS_TRANSFER"===s.type?t("div",{staticClass:"accept-message"},[e._v(" "+e._s(s.senderId===e.currentAgent.id?"已转接给"+s.payload.transferTo.data.name:"已接入来自"+s.senderData.name+"的转接")+" ")]):t("div",{staticClass:"message-item-content",class:{self:s.senderId!==e.customer.id}},[t("div",{staticClass:"sender-info"},[t("img",{staticClass:"sender-avatar",attrs:{src:s.senderData.avatar}}),t("div",{staticClass:"sender-name"},[e._v(" "+e._s(s.senderData.name)+" ")])]),t("div",{staticClass:"message-content"},[t("div",{staticClass:"message-payload"},["sending"===s.status?t("div",{staticClass:"pending"}):e._e(),"fail"===s.status?t("div",{staticClass:"send-fail"}):e._e(),"text"===s.type?t("div",{staticClass:"content-text",domProps:{innerHTML:e._s(e.renderTextMessage(s.payload.text))}}):e._e(),"image"===s.type?t("div",{staticClass:"content-image",on:{click:function(t){return e.showImage(s.payload.url)}}},[t("img",{style:{height:e.getImageHeight(s.payload.width,s.payload.height)+"px"},attrs:{src:s.payload.url}})]):e._e(),"audio"===s.type?t("goeasy-audio-player",{attrs:{duration:s.payload.duration,src:s.payload.url}}):e._e(),"video"===s.type?t("div",{staticClass:"content-video",on:{click:function(t){return e.showVideo(s.payload.video.url)}}},[t("img",{style:{height:e.getImageHeight(s.payload.thumbnail.width,s.payload.thumbnail.height)+"px"},attrs:{src:s.payload.thumbnail.url}}),t("div",{staticClass:"icon"})]):e._e(),"order"===s.type?t("div",{staticClass:"content-order"},[t("div",{staticClass:"order-description"},[e._v("发送订单：")]),t("div",{staticClass:"order-content"},[t("img",{attrs:{src:s.payload.url}}),t("div",{staticClass:"order-info"},[t("div",{staticClass:"order-name"},[e._v(e._s(s.payload.name))]),t("div",[e._v("月销"+e._s(s.payload.sales))]),t("div",[e._v(e._s(s.payload.price))])])])]):e._e()],1)])])])])}))],2),t("span",{ref:"bottomView"})]),t("div",{staticClass:"chat-footer"},[null==e.customerStatus?t("div",{staticClass:"accept-session"},[t("div",[e._v("离线中")])]):"PENDING"===e.customerStatus.status?t("div",{staticClass:"accept-session"},[t("div",{staticClass:"accept-info"},[e._v(" 会话已等待"+e._s(e.pendingTime.duration)+" ")]),t("button",{staticClass:"accept-btn",on:{click:e.acceptSession}},[e._v("立即接入")])]):"ACCEPTED"===e.customerStatus.status&&e.currentAgent.id!==e.customerStatus.agent.id?t("div",{staticClass:"accept-session"},[t("div",{staticClass:"accept-info"},[e._v(e._s(e.customerStatus.agent.data.name)+"已接入")])]):"FREE"===e.customerStatus.status?t("div",{staticClass:"accept-session"},[t("button",{staticClass:"accept-btn",on:{click:e.acceptSession}},[e._v("主动接入")])]):t("div",{staticClass:"action-box"},[t("div",{staticClass:"action-bar"},[t("div",{staticClass:"chat-action"},[t("div",{staticClass:"action-item"},[e.emoji.visible?t("div",{staticClass:"emoji-box"},e._l(e.emoji.map,(function(s,a,i){return t("img",{key:i,staticClass:"emoji-item",attrs:{src:e.emoji.url+s},on:{click:function(t){return e.chooseEmoji(a)}}})})),0):e._e(),t("i",{staticClass:"iconfont icon-smile",attrs:{title:"表情"},on:{click:e.showEmojiBox}})]),t("div",{staticClass:"action-item"},[e._m(0),t("input",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],attrs:{id:"img-input",accept:"image/*",multiple:"",type:"file"},on:{change:e.sendImageMessage}})]),t("div",{staticClass:"action-item"},[e._m(1),t("input",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],attrs:{id:"video-input",accept:"video/*",type:"file"},on:{change:e.sendVideoMessage}})])]),t("div",{staticClass:"session-action"},[t("span",{staticClass:"transfer",on:{click:function(t){return e.showTransferForm()}}},[e._v("转接")]),t("i",{staticClass:"iconfont icon-end_chat",attrs:{title:"结束会话"},on:{click:e.endSession}})])]),t("div",{staticClass:"input-box"},[t("textarea",{directives:[{name:"model",rawName:"v-model",value:e.text,expression:"text"}],ref:"input",staticClass:"input-content",attrs:{autocomplete:"off"},domProps:{value:e.text},on:{input:function(t){t.target.composing||(e.text=t.target.value)}}})]),t("div",{staticClass:"send-box"},[t("button",{staticClass:"send-button",on:{click:e.sendTextMessage}},[e._v("发送")])])])]),e.imagePopup.visible?t("div",{staticClass:"image-preview"},[t("img",{attrs:{src:e.imagePopup.url,alt:"图片"}}),t("span",{staticClass:"close",on:{click:e.hideImagePreviewPopup}},[e._v("x")])]):e._e(),e.transferForm.visible?t("div",{staticClass:"transfer-popup"},[t("div",{staticClass:"transfer-model"},[e.transferForm.agents.length?t("div",{staticClass:"transfer-content"},e._l(e.transferForm.agents,(function(s,a){return t("div",{staticClass:"agent-info"},[t("label",{staticClass:"agent-label"},[t("input",{directives:[{name:"model",rawName:"v-model",value:e.transferForm.to,expression:"transferForm.to"}],attrs:{name:s.data.name,type:"radio"},domProps:{value:s,checked:e._q(e.transferForm.to,s)},on:{change:function(t){return e.$set(e.transferForm,"to",s)}}}),t("img",{staticClass:"agent-avatar",attrs:{src:s.data.avatar}}),t("span",{staticClass:"agent-name"},[e._v(e._s(s.data.name))])])])})),0):t("div",{staticClass:"transfer-content"},[t("div",{staticClass:"no-agent"},[e._v("-当前无其他客服在线-")])]),t("div",{staticClass:"transfer-bottom"},[e.transferForm.agents.length?t("span",{staticClass:"transfer-button",on:{click:function(t){return e.transfer()}}},[e._v("确认")]):e._e(),t("span",{staticClass:"transfer-button",on:{click:function(t){return e.hideTransferForm()}}},[e._v("取消")])])])]):e._e()])},i=[function(){var e=this,t=e._self._c;return t("label",{attrs:{for:"img-input"}},[t("i",{staticClass:"iconfont icon-picture",attrs:{title:"图片"}})])},function(){var e=this,t=e._self._c;return t("label",{attrs:{for:"video-input"}},[t("i",{staticClass:"iconfont icon-film",attrs:{title:"视频"}})])}],o=s("303d");function n(e,t){this.url=e,this.patterns=[],this.emojiMap=t,this.metaChars=/[[\]{}()*+?.\\|^$\-,&#\s]/g;for(let s in this.emojiMap)this.emojiMap.hasOwnProperty(s)&&this.patterns.push("("+s.replace(this.metaChars,"\\$&")+")")}n.prototype.decode=function(e){return e.replace(new RegExp(this.patterns.join("|"),"g"),e=>"undefined"!=typeof this.emojiMap[e]?'<img height="25px" width="25px" src="'+this.url+this.emojiMap[e]+'" />':e)};var r=n,c=function(){var e=this,t=e._self._c;return t("div",{staticClass:"goeasy-audio-player",on:{click:e.play}},[t("div",{staticClass:"audio-facade",style:{width:7*Math.ceil(e.duration)+60+"px"}},[t("div",{staticClass:"audio-facade-bg",class:{"play-icon":e.playing}}),t("div",[e._v(e._s(Math.ceil(e.duration)||0)+'"')])]),t("audio",{ref:"audioPlayer",on:{ended:e.onEnd}})])},l=[],d={name:"goeasy-audio-player",props:["src","duration"],data(){return{playing:!1}},methods:{play(){this.playing=!0,this.$refs.audioPlayer.src=this.src,this.$refs.audioPlayer.load(),this.$refs.audioPlayer.currentTime=0,this.$refs.audioPlayer.play()},onEnd(){this.playing=!1}}},u=d,m=(s("1178"),s("2877")),g=Object(m["a"])(u,c,l,!1,null,"2edd0738",null),h=g.exports,p=s("6e4d");const A=200,f=150;var v={name:"Chat",components:{"goeasy-audio-player":h},data(){const e="https://imgcache.qq.com/open/qcloud/tim/assets/emoji/",t={"[么么哒]":"emoji_3@2x.png","[乒乓]":"emoji_4@2x.png","[便便]":"emoji_5@2x.png","[信封]":"emoji_6@2x.png","[偷笑]":"emoji_7@2x.png","[傲慢]":"emoji_8@2x.png"};return{currentAgent:null,csteam:null,customer:null,customerStatus:null,to:{},history:{messages:[],allLoaded:!1,loading:!0},text:"",emoji:{url:e,map:t,visible:!1,decoder:new r(e,t)},imagePopup:{visible:!1,url:""},transferForm:{visible:!1,agents:[],to:{}},pendingTime:{timer:null,duration:""}}},async created(){const e=this.$route.query.id;let t=await Object(p["a"])(e);this.customer={id:t.data.openId,name:t.data.nickname,avatar:t.data.avatar,unionId:t.data.unionid,appName:t.data.appName,mark:t.data.mark,mobileNumber:t.data.mobileNumber},this.to={type:this.GoEasy.IM_SCENE.CS,id:this.customer.id,data:this.customer},this.currentAgent=this.global.currentAgent,this.csteam=this.goEasy.im.csteam(this.currentAgent.teamId),this.liveSession(),this.loadHistoryMessage(!0,0)},beforeDestroy(){this.csteam.quitLiveSession({onSuccess:()=>{console.log("quit successfully ")},onFailed:e=>{console.log("failed to quit:",e)}})},methods:{renderCustomerName(e){return e.mark?e.mark:(-1!==e.name.indexOf("游客")&&e.mobileNumber||e.name,e.mobileNumber)},renderTextMessage(e){return this.emoji.decoder.decode(e)},liveSession(){this.csteam.liveSession({customerId:this.customer.id,onSuccess:()=>{console.log("live successfully"),this.markMessageAsRead()},onFailed:e=>{console.log("failed to live session:",e)},onStatusUpdated:e=>{this.customerStatus=e,"PENDING"===e.status&&this.updatePendingTime(e.start)},onNewMessage:e=>{console.log("onNewMessage",e),this.onReceivedMessage(e)}})},updatePendingTime(e){clearInterval(this.pendingTime.timer),this.pendingTime.timer=setInterval(()=>{this.pendingTime.duration=Object(o["b"])(e)},1800)},onReceivedMessage(e){this.history.messages.findIndex(t=>e.id===t.messageId)>=0||(this.history.messages.push(e),this.markMessageAsRead(),this.scrollToBottom())},markMessageAsRead(){this.csteam.markMessageAsRead({type:this.GoEasy.IM_SCENE.CS,id:this.customer.id,onSuccess:function(){console.log("标记已读成功")},onFailed:function(e){console.log("标记已读失败",e)}})},loadHistoryMessage(e){let t;this.history.loading=!0;let s=this.history.messages[0];s&&(t=s.timestamp);let a=10;this.csteam.history({id:this.customer.id,type:this.GoEasy.IM_SCENE.CS,lastTimestamp:t,limit:a,onSuccess:s=>{this.history.loading=!1;let a=s.content;0===a.length?this.history.allLoaded=!0:(this.history.messages=t?a.concat(this.history.messages):a,e&&this.scrollToBottom())},onFailed:e=>{this.history.loading=!1,console.log("获取历史消息失败, code:"+e.code+",错误信息:"+e.content)}})},getImageHeight(e,t){return e<A&&t<f?t:e>t?A/e*t:e===t||e<t?f:void 0},renderMessageDate(e,t){return 0===t||e.timestamp-this.history.messages[t-1].timestamp>3e5?Object(o["a"])(e.timestamp):""},showImage(e){this.callParentFunction("showImage",{url:e})},showVideo(e){this.callParentFunction("showVideo",{url:e})},callParentFunction(e,t){const s=document.referrer;window.parent.postMessage({function:e,parameters:t},s)},isOnline(){return new Promise((e,t)=>{this.csteam.isOnline({onSuccess:t=>{e(t)},onFailed:e=>{console.log("获取在线状态失败，error:",e),t(e)}})})},async acceptSession(){await this.isOnline()?this.csteam.accept({id:this.customer.id,onSuccess:()=>{console.log("accept successfully."),clearInterval(this.pendingTime.timer)},onFailed:e=>{console.log("accept failed",e)}}):alert("您还不是一名该团队的在线客服，请点击左下角头像进行上线操作")},endSession(){this.csteam.end({id:this.customer.id,onSuccess:()=>{console.log("end successfully.")},onFailed:e=>{console.log("end failed",e)}})},showTransferForm(){this.csteam.agents({onSuccess:e=>{this.transferForm.visible=!0,this.transferForm.agents=e.content.filter(e=>e.id!==this.currentAgent.id)},onFailed:e=>{console.log("query online agents failed",e)}})},transfer(){this.csteam.transfer({customerId:this.customer.id,agentId:this.transferForm.to.id,onSuccess:()=>{this.transferForm.visible=!1,console.log("transfer successfully.")},onFailed:e=>{console.log("transfer failed",e)}})},hideTransferForm(){this.transferForm.visible=!1},showEmojiBox(){this.emoji.visible=!this.emoji.visible},chooseEmoji(e){this.text+=e,this.emoji.visible=!1},sendTextMessage(){0!==this.text.trim().length?this.csteam.createTextMessage({text:this.text,to:this.to,onSuccess:e=>{this.sendMessage(e),this.text=""},onFailed:e=>{console.log("创建消息err:",e)}}):console.log("输入为空")},sendImageMessage(e){let t=[...e.target.files];t.forEach(e=>{this.csteam.createImageMessage({file:e,to:this.to,onProgress:function(e){console.log(e)},onSuccess:e=>{this.sendMessage(e)},onFailed:e=>{console.log("error :",e)}})})},sendVideoMessage(e){const t=e.target.files[0];this.csteam.createVideoMessage({file:t,to:this.to,onProgress:function(e){console.log(e)},onSuccess:e=>{this.sendMessage(e)},onFailed:e=>{console.log("error :",e)}})},sendMessage(e){this.history.messages.push(e),this.scrollToBottom(),this.goEasy.im.sendMessage({message:e,onSuccess:e=>{console.log("发送成功",e)},onFailed:function(e){507===e.code?console.log("发送语音/图片/视频/文件失败，没有配置OSS存储，详情参考：https://www.goeasy.io/cn/docs/goeasy-2.x/im/message/media/send-media-message.html"):console.log("发送失败:",e)}})},scrollToBottom(){this.$nextTick(()=>{this.$refs.bottomView&&this.$refs.bottomView.scrollIntoView()})}}},C=v,y=(s("3b56"),Object(m["a"])(C,a,i,!1,null,"6f10133c",null));t["default"]=y.exports},1178:function(e,t,s){"use strict";s("d537")},"1dee":function(e,t,s){e.exports=s.p+"img/default.f0e98eaa.png"},"303d":function(e,t,s){"use strict";function a(e){e=e||Date.now();let t=new Date(e),s=t.getMonth()<9?"0"+(t.getMonth()+1):t.getMonth()+1;return s+="-",s+=t.getDate()<10?"0"+t.getDate():t.getDate(),s+=" ",s+=t.getHours(),s+=":",s+=t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes(),s}function i(e){const t=600,s=60*t,a=60*s,i=24*a,o=(new Date).getTime(),n=o-e,r=n/t,c=n/s,l=n/a,d=n/i;return d>=1?parseInt(d)+"天":l>=1?parseInt(l)+"小时":c>=1?parseInt(c)+"分钟":r>=1?parseInt(r)+"秒":"0秒"}s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return i}))},"3b56":function(e,t,s){"use strict";s("bfb3")},"6e4d":function(e,t,s){"use strict";s.d(t,"c",(function(){return h})),s.d(t,"d",(function(){return p})),s.d(t,"b",(function(){return A})),s.d(t,"f",(function(){return f})),s.d(t,"a",(function(){return v})),s.d(t,"e",(function(){return C}));class a{getAccessToken(){let e=Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_ENV,t=this.getCookie("goeasy.token."+e);return t}getRefreshToken(){let e=Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_ENV,t=this.getCookie("goeasy.refreshToken."+e);return t}storeTokens(e,t,s){let a=Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_ENV;this.setCookie("goeasy.token."+a,e),this.setCookie("goeasy.refreshToken."+a,t),this.setCookie("goeasy.token.expiresAtMillis."+a,s+"")}setCookie(e,t){console.log("will set "+e+"with value: "+t),document.cookie=e+"="+escape(t)+";domain=goeasy.io"}getCookie(e){let t,s=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(s))?unescape(t[2]):null}}var i=new a,o=s("bc3a"),n=s.n(o);const r=Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_ENV;function c(){let e;e=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHttp");let t=`https://${r}sso.goeasy.io`,s=i.getCookie("goeasy.token.expiresAtMillis."+r),a=(new Date).getTime();if(e&&s-a<36e5){let s=i.getRefreshToken();e.open("post",t+"/refreshtoken",!0),e.setRequestHeader("content-type","application/x-www-form-urlencoded"),e.send("refreshToken="+s),e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){let t=JSON.parse(e.responseText),s=t.token,a=t.refreshToken,o=t.expiresAtMillis;i.storeTokens(s,a,o)}}}}const l=n.a.create({baseURL:"",timeout:6e4});l.interceptors.request.use(e=>{c();const t=i.getAccessToken();return t&&(e.headers["Authorization"]="Bearer "+t),e},e=>Promise.reject(e)),l.interceptors.response.use(e=>e.data,e=>Promise.reject(e));var d=l;let u=Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_ENV;const m=`https://${u}center.goeasy.io/api/v1`,g=`https://${u}center.goeasy.io/api/v2/cs-agent`;function h(){let e=g+"/otp";return d({url:e,method:"POST"})}function p(){let e=m+"/admin/currentuser";return d({url:e,method:"GET"})}function A(e){let t=g+"/contacts";return d({url:t,data:{search:e},method:"POST"})}function f(e,t){let s=`${g}/contacts/${e}/mark`;return d({url:s,data:{mark:t},method:"POST"})}function v(e){let t=`${g}/contacts/${e}`;return d({url:t,method:"GET"})}function C(e){let t=`${g}/contacts/${e.openId}/mobile-number`;return d({url:t,data:{mobileNumber:e.mobileNumber},method:"POST"})}},"912a":function(e,t){e.exports="data:image/gif;base64,R0lGODlhEAAQALMMAKqooJGOhp2bk7e1rZ2bkre1rJCPhqqon8PBudDOxXd1bISCef///wAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQFAAAMACwAAAAAEAAQAAAET5DJyYyhmAZ7sxQEs1nMsmACGJKmSaVEOLXnK1PuBADepCiMg/DQ+/2GRI8RKOxJfpTCIJNIYArS6aRajWYZCASDa41Ow+Fx2YMWOyfpTAQAIfkEBQAADAAsAAAAABAAEAAABE6QyckEoZgKe7MEQMUxhoEd6FFdQWlOqTq15SlT9VQM3rQsjMKO5/n9hANixgjc9SQ/CgKRUSgw0ynFapVmGYkEg3v1gsPibg8tfk7CnggAIfkEBQAADAAsAAAAABAAEAAABE2QycnOoZjaA/IsRWV1goCBoMiUJTW8A0XMBPZmM4Ug3hQEjN2uZygahDyP0RBMEpmTRCKzWGCkUkq1SsFOFQrG1tr9gsPc3jnco4A9EQAh+QQFAAAMACwAAAAAEAAQAAAETpDJyUqhmFqbJ0LMIA7McWDfF5LmAVApOLUvLFMmlSTdJAiM3a73+wl5HYKSEET2lBSFIhMIYKRSimFriGIZiwWD2/WCw+Jt7xxeU9qZCAAh+QQFAAAMACwAAAAAEAAQAAAETZDJyRCimFqbZ0rVxgwF9n3hSJbeSQ2rCWIkpSjddBzMfee7nQ/XCfJ+OQYAQFksMgQBxumkEKLSCfVpMDCugqyW2w18xZmuwZycdDsRACH5BAUAAAwALAAAAAAQABAAAARNkMnJUqKYWpunUtXGIAj2feFIlt5JrWybkdSydNNQMLaND7pC79YBFnY+HENHMRgyhwPGaQhQotGm00oQMLBSLYPQ9QIASrLAq5x0OxEAIfkEBQAADAAsAAAAABAAEAAABE2QycmUopham+da1cYkCfZ94UiW3kmtbJuRlGF0E4Iwto3rut6tA9wFAjiJjkIgZAYDTLNJgUIpgqyAcTgwCuACJssAdL3gpLmbpLAzEQA7"},bfb3:function(e,t,s){},d537:function(e,t,s){}}]);
//# sourceMappingURL=chunk-2265b2f0.aa254f69.js.map