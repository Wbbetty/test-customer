(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-c5409f04"],{1023:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=n("f266"),i=function(){function t(t){this.config=t,this.http=new o.default(t),this.center="".concat(t.rest_host,"/api/v1"),this.agentBaseUrl="".concat(t.rest_host,"/api/v2/cs-agent")}return t.prototype.getOTP=function(){var t="".concat(this.agentBaseUrl,"/otp");return this.http.call({url:t,method:"POST"})},t.prototype.getWorkerInfo=function(){var t="".concat(this.center,"/admin/currentuser");return this.http.call({url:t,method:"GET"})},t.prototype.getContacts=function(t){var e="".concat(this.agentBaseUrl,"/contacts");return this.http.call({url:e,data:{search:t},method:"POST"})},t.prototype.updateUserMark=function(t,e){var n="".concat(this.agentBaseUrl,"/contacts/").concat(t,"/mark");return this.http.call({url:n,data:{mark:e},method:"POST"})},t.prototype.getContact=function(t){var e="".concat(this.agentBaseUrl,"/contacts/").concat(t);return this.http.call({url:e,method:"GET"})},t.prototype.updateMobileNumber=function(t){var e="".concat(this.agentBaseUrl,"/contacts/").concat(t.openId,"/mobile-number");return this.http.call({url:e,data:{mobileNumber:t.mobileNumber},method:"POST"})},t.prototype.getWelcome=function(){var t="".concat(this.agentBaseUrl,"/mywelcome");return this.http.call({url:t,method:"GET"})},t}();e.default=i},"293c":function(t,e,n){},"4e9e":function(t,e,n){"use strict";n("293c")},"53c6":function(t,e,n){t.exports=n.p+"img/logo.897bbe5b.png"},b548:function(t,e,n){"use strict";n.r(e);var o=function(){var t=this,e=t._self._c;return e("div",{staticClass:"home"},[e("div",{staticClass:"home-container"},[e("div",{staticClass:"home-menu"},[e("div",{staticClass:"menu-header"},[t.goeasyTeam.data.avatar?e("img",{staticClass:"shop-avatar",attrs:{src:t.goeasyTeam.data.avatar}}):e("img",{staticClass:"shop-avatar",attrs:{src:n("53c6")}}),e("div",{staticClass:"team-info"},[t._v(" "+t._s(t.goeasyTeam.data.name)+" ")])]),e("div",{staticClass:"menu-box"},[e("div",{staticClass:"menu-list"},[e("div",{staticClass:"menu-item"},[e("router-link",{attrs:{tag:"span",to:"/agent/conversations"}},[e("i",{staticClass:"iconfont icon-zaixiankefu",class:{selected:"conversations"===t.selectedTab}})]),t.unreadAmount+t.pendingConversationAmount?e("span",{staticClass:"menu-unread"},[t._v(t._s(t.unreadAmount+t.pendingConversationAmount))]):t._e()],1),e("div",{staticClass:"menu-item"},[e("router-link",{attrs:{tag:"span",to:"/agent/customers"}},[e("i",{staticClass:"iconfont icon-haoyou",class:{selected:"customers"===t.selectedTab}})])],1)]),t.currentAgent?e("div",{staticClass:"agent-info"},[e("img",{staticClass:"agent-avatar",attrs:{src:t.currentAgent.avatar},on:{click:function(e){t.onlineConfig.visible=!t.onlineConfig.visible}}}),e("span",{class:t.onlineConfig.online?"spot online":"spot offline"}),e("div",{staticClass:"agent-name"},[t._v(t._s(t.currentAgent.name))])]):t._e(),t.onlineConfig.visible?e("div",{staticClass:"action-wrap",on:{click:function(e){return e.preventDefault(),t.closeOnlinePopup()}}},[t.onlineConfig.visible?e("div",{staticClass:"action-box"},[e("div",{staticClass:"action-item",on:{click:t.online}},[e("div",{class:t.onlineConfig.online?"checked":"action-title"},[t._v("客服在线")]),e("div",{staticClass:"action-detail"},[t._v("接收客服消息通知")])]),e("div",{staticClass:"action-item",on:{click:t.offline}},[e("div",{class:t.onlineConfig.online?"action-title":"checked"},[t._v("客服离线")]),e("div",{staticClass:"action-detail"},[t._v("不接收客服消息通知")])])]):t._e()]):t._e()]),e("div",{staticClass:"version"},[t._v(t._s(t.version))])]),e("div",{staticClass:"home-main"},[e("router-view")],1)])])},i=[],s=(n("f90e"),n("1023")),a=n.n(s),c=n("4bac"),r=n.n(c),l=n("9224"),u={name:"Home",data(){return{version:l["a"],goeasyTeam:{id:"goeasy-customer-support",data:{name:"GoEasy Support Team",avatar:""}},csteam:null,currentAgent:null,selectedTab:"",unreadAmount:0,pendingConversationAmount:0,onlineConfig:{visible:!1,online:!1}}},async created(){let t=JSON.parse(this.$route.query.cs_agent_config);this.global.api=new a.a(t);let e=r.a.getInstance({host:t.goEasy_host,appkey:t.goEasy_appKey,modules:["im"]});this.global.GoEasy=r.a,this.global.goEasy=e;let n=await this.global.api.getWorkerInfo(),o=await this.global.api.getWelcome();this.global.welcome=o.data,this.global.currentAgent={id:n.data.userguid,name:n.data.name,avatar:n.data.avatar,teamId:this.goeasyTeam.id},this.currentAgent=this.global.currentAgent,"disconnected"===this.global.goEasy.getConnectionStatus()&&(await this.connectGoEasy(),this.$router.push({path:"/agent/conversations"})),this.csteam=this.global.goEasy.im.csteam(this.goeasyTeam.id),this.initialOnlineStatus(),this.initListeners()},watch:{$route:{handler(){let t=this.$route.path,e=t.split("/");this.selectedTab=e[2]},immediate:!0}},methods:{initListeners(){document.addEventListener("visibilitychange",()=>{document.hidden||this.callParentFunction("clearNotificationTitle")}),this.global.goEasy.im.on(this.global.GoEasy.IM_EVENT.CONVERSATIONS_UPDATED,this.onConversationUpdate),this.global.goEasy.im.on(this.global.GoEasy.IM_EVENT.PENDING_CONVERSATIONS_UPDATED,this.onPendingConversationUpdate)},async connectGoEasy(){let t=await this.global.api.getOTP();return new Promise((e,n)=>{this.global.goEasy.connect({id:this.currentAgent.id,data:{name:this.currentAgent.name,avatar:this.currentAgent.avatar},otp:t.data,onSuccess:()=>{console.log("GoEasy connect successfully."),e()},onFailed:t=>{console.log("Failed to connect GoEasy, code:"+t.code+",error:"+t.content),n(t)},onProgress:t=>{console.log("GoEasy is connecting",t)}})})},onConversationUpdate(t){t.unreadTotal>this.unreadAmount&&(this.sendNotification(),this.callParentFunction("showPopup")),this.unreadAmount=t.unreadTotal},onPendingConversationUpdate(t){t.conversations.length>this.pendingConversationAmount&&(this.sendNotification(),this.callParentFunction("showPopup")),this.pendingConversationAmount=t.conversations.length},sendNotification(){if("visible"===document.visibilityState)return;const t={title:"GoEasy Agent",body:"您有一条新的消息"};this.callParentFunction("createNotification",t)},callParentFunction(t,e){const n=document.referrer;window.parent.postMessage({function:t,parameters:e},n)},initialOnlineStatus(){this.csteam.isOnline({onSuccess:t=>{this.onlineConfig.online=t},onFailed:t=>{console.log("获取在线状态失败，error:",t)}})},offline(){this.csteam.offline({onSuccess:()=>{this.onlineConfig.online=!1,this.onlineConfig.visible=!1},onFailed:t=>{"Please end your accepted conversations first"===t.content&&alert("下线失败,请先结束已接入的会话！"),console.log("下线失败,error:",t)}})},online(){this.csteam.online({teamData:{name:this.goeasyTeam.name,avatar:this.goeasyTeam.avatar},agentData:{name:this.currentAgent.name,avatar:this.currentAgent.avatar},onSuccess:()=>{this.onlineConfig.online=!0},onFailed:t=>{console.log("上线失败,error:",t)}})},closeOnlinePopup(){this.onlineConfig.visible=!1}}},h=u,g=(n("4e9e"),n("2877")),d=Object(g["a"])(h,o,i,!1,null,"8e4b4c32",null);e["default"]=d.exports},f266:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=n("bc3a"),i=function(){function t(t){var e=this;this.config=t,this.cookie_token_key="goeasy.token.".concat(this.config.sso_cookie_suffix),this.cookie_refresh_token_key="goeasy.refreshToken.".concat(this.config.sso_cookie_suffix),this.cookie_expiresAtMillis_key="goeasy.token.expiresAtMillis.".concat(this.config.sso_cookie_suffix),this.call=o.default.create({baseURL:"",timeout:6e4}),this.call.interceptors.request.use((function(t){e.checkAndRefreshToken();var n=e.getAccessToken();return n&&(t.headers["Authorization"]="Bearer "+n),t}),(function(t){return Promise.reject(t)})),this.call.interceptors.response.use((function(t){return t.data}),(function(t){return Promise.reject(t)}))}return t.prototype.checkAndRefreshToken=function(){var t,e=this;t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHttp");var n=this.getExpiresAtMillis(),o=(new Date).getTime();if(t&&n-o<36e5){var i=this.getRefreshToken();t.open("post","".concat(this.config.sso_host,"/refreshtoken"),!0),t.setRequestHeader("content-type","application/x-www-form-urlencoded"),t.send("refreshToken="+i),t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){var n=JSON.parse(t.responseText),o=n.token,i=n.refreshToken,s=n.expiresAtMillis;e.storeTokens(o,i,s)}}}},t.prototype.getExpiresAtMillis=function(){return this.getCookie(this.cookie_expiresAtMillis_key)},t.prototype.getAccessToken=function(){return this.getCookie("goeasy.token.".concat(this.config.sso_cookie_suffix))},t.prototype.getRefreshToken=function(){return this.getCookie("goeasy.refreshToken.".concat(this.config.sso_cookie_suffix))},t.prototype.storeTokens=function(t,e,n){this.setCookie(this.cookie_token_key,t),this.setCookie(this.cookie_refresh_token_key,e),this.setCookie(this.cookie_expiresAtMillis_key,n+"")},t.prototype.setCookie=function(t,e){console.log("will set "+t+"with value: "+e),document.cookie=t+"="+escape(e)+";domain=goeasy.io"},t.prototype.getCookie=function(t){var e,n=new RegExp("(^| )"+t+"=([^;]*)(;|$)");return(e=document.cookie.match(n))?unescape(e[2]):null},t}();e.default=i},f90e:function(t,e,n){}}]);
//# sourceMappingURL=chunk-c5409f04.e8fc8c5e.js.map